---
output: github_document
---

### Data processing workflow

I'm trying to document the data processing workflow. I am using the packages `tidyverse` and `readxl` (documentation: https://readxl.tidyverse.org/). Link to the Issue documentation for the data processing workflow: https://github.com/gregor-fausto/clarkiaSeedBanks/issues/6. 

- [File directories](#file-directories)
- [Processing data](#processing-data)
- [Seeds per fruit data](#seeds-per-fruit-data)
- [Fruits per plant data](#fruits-per-plant-data)
- [Seedlings and fruiting plant data](#seedlings-and-fruiting-plant-data)
- [Seed bag data](#seed-bag-data)

### File directories

The files holding datasets are originally found in the shared Dropbox folder `.../Dropbox/Clarkia-LTREB/20_demography_sites/`. I created a folder on my local Dropbox `/Users/Gregor/Dropbox/dataLibrary/` to hold a copy of these files. To copy the files, I run the following in my Terminal:

`cp /Users/Gregor/Dropbox/Clarkia-LTREB/20_demography_sites/* /Users/Gregor/Dropbox/dataLibrary/Clarkia-LTREB/20_demography_sites/`

I last ran this on 02/05/20 at 3:18 PM. The files in this directory are now a copy of those in the shared Dropbox folder. For the time being, the copy of the files remains outside of the folder that gets updated on Git. 

An additional folder holding datasets is originally found in the shared Dropbox folder `.../Dropbox/Clarkia-LTREB/data and scripts/files from monica/`. I created a folder on my local Dropbox `/Users/Gregor/Dropbox/dataLibrary/` to hold a copy of these files. To copy the files, I run the following in my Terminal:

`cp /Users/Gregor/Dropbox/Clarkia-LTREB/data\ and\ scripts/files\ from\ monica/* /Users/Gregor/Dropbox/dataLibrary/Clarkia-LTREB/data\ and\ scripts/files\ from\ monica/`

I last ran this on 02/06/20 at 10:50 AM. The files in this directory are now a copy of those in the shared Dropbox folder. For the time being, the copy of the files remains outside of the folder that gets updated on Git. 

Additional changes:

- saved `/Users/Gregor/Dropbox/dataLibrary/Clarkia-LTREB/20_demography_sites/seeds_2011.xls` as `/Users/Gregor/Dropbox/dataLibrary/Clarkia-LTREB/20_demography_sites/seeds_2011.xlsx`
- saved `/Users/Gregor/Dropbox/dataLibrary/Clarkia-LTREB/20_demography_sites/seeds_2012.xls` as `/Users/Gregor/Dropbox/dataLibrary/Clarkia-LTREB/20_demography_sites/seeds_2012.xlsx`
- deleted empty rows at the bottom of the file `/Users/Gregor/Dropbox/dataLibrary/Clarkia-LTREB/20_demography_sites/seeds_2012.xlsx`; these are filled with some formatting and otherwise may give problems with data importing

- saved `/Users/Gregor/Dropbox/dataLibrary/Clarkia-LTREB/20_demography_sites/seeds_2013.xls` as `/Users/Gregor/Dropbox/dataLibrary/Clarkia-LTREB/20_demography_sites/seeds_2013.xlsx`
- deleted empty rows at the bottom of the file `/Users/Gregor/Dropbox/dataLibrary/Clarkia-LTREB/20_demography_sites/seeds_2013.xlsx`; these are filled with some formatting and otherwise may give problems with data importing

- saved `/Users/Gregor/Dropbox/dataLibrary/Clarkia-LTREB/20_demography_sites/seeds_2014.xls` as `/Users/Gregor/Dropbox/dataLibrary/Clarkia-LTREB/20_demography_sites/seeds_2014.xlsx`
- deleted empty rows at the bottom of the file `/Users/Gregor/Dropbox/dataLibrary/Clarkia-LTREB/20_demography_sites/seeds_2014.xlsx`, sheet 2; these are filled with some formatting and otherwise may give problems with data importing

- saved `/Users/Gregor/Dropbox/dataLibrary/Clarkia-LTREB/20_demography_sites/seeds_2015.xls` as `/Users/Gregor/Dropbox/dataLibrary/Clarkia-LTREB/20_demography_sites/seeds_2015.xlsx`


### Processing data {#processing-data-link}

Load the libraries for data processing (see https://github.com/r-lib/rlang/issues/669 for the overwrite message I am suppressing)

```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(readxl)
library(knitr)
library(lubridate)
library(tidyxl)
```

Scripts for the original processing I did is located in the following folder. I want to document when I last updated these files before I start updating the workflow. None of the original scripts are going to be changed. 

```{r}
dir = c("/Users/Gregor/Dropbox/projects/clarkiaScripts/code/reshapeDataScripts/")
files = list.files(path=dir)
dt <- data.frame(files)
fileModified <- function(x){file.info(paste0(dir,x))$mtime}

for(i in 1:dim(dt)[1]){
  dt[i,2] <- ymd_hms(fileModified(files[i])) %>%
    data.frame() %>% rename(dateTime='.') 
}

kable(dt)
```

### Seeds per fruit data {#seeds-per-fruit-data-link}

Start with the seed data. This is file `.../reshapeSeeds.R` file in the list above.

```{r}
setwd("/Users/Gregor/Dropbox/dataLibrary/Clarkia-LTREB/20_demography_sites")

filenames<-list.files(pattern=paste("^seeds_"), recursive=TRUE)
worksheet_2006.2010 <- filenames[1:5]
worksheet_2011.2012 <- filenames[c(7,9)]
worksheet_2013.2015 <- filenames[c(11,13,15)]
print(c(worksheet_2006.2010,worksheet_2011.2012,worksheet_2013.2015))

seedFiles<-c(worksheet_2006.2010,worksheet_2011.2012,worksheet_2013.2015)
fileList<-paste0("/Users/Gregor/Dropbox/dataLibrary/Clarkia-LTREB/20_demography_sites/",seedFiles)
```

Check and count which spreadsheets have multiple sheets:

```{r}
nSheets<-lapply(lapply(fileList,excel_sheets),length)
unlist(nSheets)
```

Check the number of columns in each spreadshseet:

```{r, message=FALSE}
# files for 2006-2012
unlist(lapply(lapply(fileList[1:7],read_excel),ncol))
# files for 2013-2015, sheet 1
unlist(lapply(lapply(fileList[8:10],read_excel,sheet=1),ncol))
# files for 2013-2015, sheet 2
unlist(lapply(lapply(fileList[8:10],read_excel,sheet=2),ncol))
```

The data files for 2006-2010 have two columns. The data files include 1 sheet with the following data: 1 column for the site at which the undamaged fruit was collected, and 1 column for the number of seeds in the undamaged fruit.

```{r}
yearExtract<-function(x){
  tmp<-as.numeric(sapply(strsplit(x, c("[seeds_.xls]")), "["))
  tmp<-tmp[!is.na(tmp)]
  tmp
}

years <- unlist(lapply(fileList[1:5],yearExtract))

reshapeFun <- function(x){
x %>%
  dplyr::rename(site='Site') %>%
  dplyr::rename(seedCount = `Seed no per fruit`) %>%
  dplyr::mutate(damageStatusBinary = 0, permanentPlotBinary = NA)
}

fileDfs<-lapply(fileList[1:5],read_excel)
fileDfs<-lapply(fileDfs,reshapeFun)

for(i in 1:length(years)){
  fileDfs[[i]] <- fileDfs[[i]] %>%
      dplyr::mutate(year=years[i])
}

seed20062010 <- fileDfs %>% 
  purrr::reduce(full_join) 
```

The data files for 2011-2012 have four columns: (1) a column for the site at which the undamaged fruit was collected, (2) a column for the number of seeds in the undamaged fruit, and (3) a column indicating whether the fruit was collected from a permanent plot or from across the site. (4) An additional column has notes: some seed counts were randomly resampled from previous years' counts and some sites did not have any undamaged fruits in the given year. 

```{r}
yearExtract<-function(x){
  tmp<-as.numeric(sapply(strsplit(x, c("[seeds_.xls]")), "["))
  tmp<-tmp[!is.na(tmp)]
  tmp
}

years <- unlist(lapply(fileList[6:7],yearExtract))

reshapeFun <- function(x){
x %>%
  dplyr::rename(site='Site') %>%
  dplyr::rename(seedCount = `Seed no per fruit`) %>%
  dplyr::mutate(damageStatusBinary = 0)
}

appendFontColor <- function(x){

# Step 1: import the table taking only cell values and ignoring the formatting
tidyExcel <- read_excel(x,na="NA") 
tidyExcel <- reshapeFun(tidyExcel)

# Step 2: import one column of the table, taking only the formatting and not the
# cell values

# `formats` is a pallette of fill colours that can be indexed by the
# `local_format_id` of a given cell to get the fill colour of that cell
font_colours <- xlsx_formats(x)$local$font$color$rgb

# Import all the cells, filter out the header row, filter for the first column,
# and create a new column `font_colour` of the font colours, by looking up the
# local_format_id of each cell in the `font_colours` pallette.
fonts <- xlsx_cells(x, sheet = 1) %>%
  filter(row >= 2, col == 1) %>% # Omit the header row
  mutate(font_colour = font_colours[local_format_id]) %>%
  select(font_colour)

# Step 3: append the `font` column to the rest of the data
tmp <- bind_cols(tidyExcel, fonts)

out <- tmp %>% 
  dplyr::select(site,seedCount,permanentPlot,damageStatusBinary,font_colour) %>%
  dplyr::mutate(fieldData = ifelse(font_colour=="FF000000",1,0)) %>%
  dplyr::select(-font_colour)

return(out)

}

fileDfs<-lapply(fileList[6:7],appendFontColor)

for(i in 1:length(years)){
  fileDfs[[i]] <- fileDfs[[i]] %>%
      dplyr::mutate(year=years[i])
}

seed20112012 <- fileDfs %>% 
  purrr::reduce(full_join) 

seed20112012 %>% 
  dplyr::filter(permanentPlot!=fieldData)
```

From 2013-2015, we collected data on the number of seeds per undamaged fruit and the number of seeds per damaged fruit. The data files thus include two sheets, 1 for the number of seeds per undamaged fruit and 1 for the numbe of seeds per damaged fruit. At each site, undamaged fruits were collected from plants spread across the entire site. The data files thus include 1 column for the site at which the undamaged fruit was collected, and 1 column for the number of seeds in the fruit. 

The sheets for undamaged fruits have the following columns: 1 column for the site at which the undamaged fruit was collected, 1 column for the number of seeds in the undamaged fruit, and 1 column indicating whether the fruit was collected from a permanent plot or from across the site. A fourth column has notes: some seed counts were randomly resampled from previous years' counts and some sites did not have any undamaged fruits in the given year. Some of the data files have empty columns between the data and the notes.

```{r}
yearExtract<-function(x){
  tmp<-as.numeric(sapply(strsplit(x, c("[seeds_.xls]")), "["))
  tmp<-tmp[!is.na(tmp)]
  tmp
}

years <- unlist(lapply(fileList[8:10],yearExtract))

reshapeFun <- function(x){
x %>%
  dplyr::rename(site='Site') %>%
  dplyr::rename(seedCount = `Seed no per undamaged fruit`) %>%
  dplyr::mutate(damageStatusBinary = 0)
}

appendFontColor <- function(x){

# Step 1: import the table taking only cell values and ignoring the formatting
tidyExcel <- read_excel(x,na="NA",sheet=1) 
tidyExcel <- reshapeFun(tidyExcel)

# Step 2: import one column of the table, taking only the formatting and not the
# cell values

# `formats` is a pallette of fill colours that can be indexed by the
# `local_format_id` of a given cell to get the fill colour of that cell
font_colours <- xlsx_formats(x)$local$font$color$rgb

# Import all the cells, filter out the header row, filter for the first column,
# and create a new column `font_colour` of the font colours, by looking up the
# local_format_id of each cell in the `font_colours` pallette.
fonts <- xlsx_cells(x, sheet = 1) %>%
  filter(row >= 2, col == 1) %>% # Omit the header row
  mutate(font_colour = font_colours[local_format_id]) %>%
  select(font_colour)

# Step 3: append the `font` column to the rest of the data
tmp <- bind_cols(tidyExcel, fonts)

out <- tmp %>% 
  dplyr::select(site,seedCount,permanentPlot,damageStatusBinary,font_colour) %>%
  dplyr::mutate(fieldData = ifelse(font_colour=="FF000000"|font_colour=="FF008000",1,0)) %>%
  dplyr::select(-font_colour)

return(out)

}

fileDfs<-lapply(fileList[8:10],appendFontColor)

for(i in 1:length(years)){
  fileDfs[[i]] <- fileDfs[[i]] %>%
      dplyr::mutate(year=years[i])
}

seedUndamaged20132015 <- fileDfs %>% 
  purrr::reduce(full_join) 

seedUndamaged20132015 %>% 
  dplyr::filter(permanentPlot!=fieldData)
```


The sheets for damaged fruits have the following columns: 1 column for the site at which the damaged fruit was collected, and 1 column for the number of seeds in the damaged fruit. Another column has notes: some sites did not have any damaged fruits in the given year. Some of the data files have empty columns between the data and the notes.

```{r}
yearExtract<-function(x){
  tmp<-as.numeric(sapply(strsplit(x, c("[seeds_.xls]")), "["))
  tmp<-tmp[!is.na(tmp)]
  tmp
}

years <- unlist(lapply(fileList[8:10],yearExtract))

reshapeFun <- function(x){
x %>%
  dplyr::rename(site='Site') %>%
  dplyr::rename(seedCount = `Seed no per damaged fruit`) %>%
  dplyr::mutate(damageStatusBinary = 1, permanentPlot = NA)
}

appendFontColor <- function(x){

# Step 1: import the table taking only cell values and ignoring the formatting
tidyExcel <- read_excel(x,na=c("NA","MA"),sheet=2) 
tidyExcel <- reshapeFun(tidyExcel)

# Step 2: import one column of the table, taking only the formatting and not the
# cell values

# `formats` is a pallette of fill colours that can be indexed by the
# `local_format_id` of a given cell to get the fill colour of that cell
font_colours <- xlsx_formats(x)$local$font$color$rgb

# Import all the cells, filter out the header row, filter for the first column,
# and create a new column `font_colour` of the font colours, by looking up the
# local_format_id of each cell in the `font_colours` pallette.
fonts <- xlsx_cells(x, sheet = 2) %>%
  filter(row >= 2, col == 1) %>% # Omit the header row
  mutate(font_colour = font_colours[local_format_id]) %>%
  select(font_colour)

# Step 3: append the `font` column to the rest of the data
tmp <- bind_cols(tidyExcel, fonts)

out <- tmp %>% 
  dplyr::select(site,seedCount,permanentPlot,damageStatusBinary,font_colour) %>%
  dplyr::mutate(fieldData = ifelse(font_colour=="FF000000"|font_colour=="FF008000",1,0)) %>%
  dplyr::select(-font_colour)

return(out)

}

fileDfs<-lapply(fileList[8:10],appendFontColor)

for(i in 1:length(years)){
  fileDfs[[i]] <- fileDfs[[i]] %>%
      dplyr::mutate(year=years[i])
}

seedDamaged20132015 <- fileDfs %>% 
  purrr::reduce(full_join) 

seedDamaged20132015 %>% 
  dplyr::filter(permanentPlot!=fieldData)
```

It might be useful to summarize the datasets:

```{r}
summary20062010<-seed20062010 %>%
  dplyr::group_by(year,site) %>%
  dplyr::summarise(count = sum(!is.na(seedCount))) %>%
  tidyr::spread(key="year",value="count")

summary20112012<-seed20112012 %>%
  dplyr::group_by(year,site) %>%
  dplyr::summarise(count = sum(!is.na(seedCount))) %>%
  tidyr::spread(key="year",value="count")

summaryUndamaged20132012<-seedUndamaged20132015  %>%
  dplyr::group_by(year,site) %>%
  dplyr::summarise(count = sum(!is.na(seedCount))) %>%
  tidyr::spread(key="year",value="count")

summaryDamaged20132012<-seedDamaged20132015  %>%
  dplyr::group_by(year,site) %>%
  dplyr::summarise(count = sum(!is.na(seedCount))) %>%
  tidyr::spread(key="year",value="count")

summaryTable <- summary20062010 %>%
  dplyr::full_join(summary20112012) %>%
  dplyr::full_join(summaryUndamaged20132012)

kable(summaryTable, caption="Summary table of the number of counts of seeds from undamaged fruits")

kable(summaryDamaged20132012, caption="Summary table of the number of counts of seeds from damaged fruits")
```

### Fruits per plant data
### Seedlings and fruiting plant data


Start with the survival data. This is file `.../reshapeSeeds.R` file in the list above.

```{r}
# dir=c("/Users/Gregor/Dropbox/dataLibrary/Clarkia-LTREB/20_demography_sites/")
# 
# tmp <- read_excel(paste0(dir,"Surv_Fec_env_06-15.xls"),sheet = 1,na="NA")
# surv_fec <- tmp %>%
#   dplyr::rename(year=year_spring)
# 
# ###########################################################################
# # Survival and fecundity
# ###########################################################################
# survival <- surv_fec %>%
#   select(c(site,year,transect,position,seedling.,fruitpl.,tot_or_undamaged_frperpl.,damaged_frpl.))
# 
# survival <- survival %>%
#   dplyr::rename(noSeedlings = seedling.) %>%
#   dplyr::rename(noFruitingPlants = fruitpl.) %>%
#   dplyr::rename(noTotalFruitEqUndFruitsPerPl = tot_or_undamaged_frperpl.) %>%
#   dplyr::rename(noDamFruitsPerPl = damaged_frpl.)
```
### Seed bag data

Data for seed bags from the field.

```{r}
dir=c("/Users/Gregor/Dropbox/dataLibrary/Clarkia-LTREB/20_demography_sites/")

tmp <- read_excel(paste0(dir,"seed bag data.xls"),sheet = 1,na=c("NA","?"))

seedBags <- tmp %>%
  dplyr::rename(bagNo = 'bag #') %>%
  dplyr::rename(round = 'Round') %>%
  dplyr::rename(yearStart = 'Start_yr(Oct)') %>%
  dplyr::rename(age = 'Age') %>%
  dplyr::rename(yearData = 'Yr_germ(Jan)/viability(Oct)') %>%
  dplyr::rename(seedlingJan = 'Jan_germ') %>%
  dplyr::rename(intactJan = 'Jan_intact') %>%
  dplyr::rename(totalJan = 'Jan_total') %>%
  dplyr::rename(intactOct = 'Oct_intact') %>%
  dplyr::select(-c("viability%"))

# january germinants
summarySeedBags<-seedBags  %>%
  tidyr::unite("yearAge", yearData,age,sep="-age") %>%
  dplyr::group_by(yearAge,site) %>%
  dplyr::summarise(count = sum(!is.na(seedlingJan))) %>%
  tidyr::spread(key=c("yearAge"),value="count")

kable(summarySeedBags, caption="Summary table of the number of seed bags counted in January for intact and germinated seeds")

# october intacts
summarySeedBags<-seedBags  %>%
  tidyr::unite("yearAge", yearData,age,sep="-age") %>%
  dplyr::group_by(yearAge,site) %>%
  dplyr::summarise(count = sum(!is.na(intactOct))) %>%
  tidyr::spread(key=c("yearAge"),value="count")

kable(summarySeedBags, caption="Summary table of the number of seed bags counted in October for intact seeds")

```

```{r}
dir=c("/Users/Gregor/Dropbox/dataLibrary/Clarkia-LTREB/data and scripts/files from monica/")

tmp <- read_excel(paste0(dir,"germ_viab_data_final_updated.xlsx"),sheet = 1,na=c("NA","?"))

viabilityRawData <- tmp %>%
  dplyr::rename(site = 'population') %>%
  dplyr::rename(bagNo = 'bag#') %>%
  dplyr::rename(round = 'Round') %>%
  dplyr::rename(age = 'Age') %>%
  dplyr::rename(block = 'Block') %>%
  dplyr::rename(germStart = '#tested_for_germination') %>%
  dplyr::rename(germCount = '#germinating') %>%
  dplyr::rename(germPerc = '%Germ') %>%
  dplyr::rename(germNot = '#not germinated') %>%
  dplyr::rename(viabStart = '#tested_for_viability') %>%
  dplyr::rename(viabStain = '#viable(stained_red)') %>%
  dplyr::rename(viabPerc = '%viability') %>%
  dplyr::rename(condTest = '#not_germinated=#tested_for_viability?') %>%
  dplyr::rename(viabPerc2 = '%Viabil') %>%
  dplyr::rename(viabTotal = 'Overall_viability')

```

Data for viability trials in the lab. 



